<Window x:Class="ollamidesk.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:views="clr-namespace:ollamidesk.RAG.Views"
        xmlns:local="clr-namespace:ollamidesk"
        Title="Ollama Chat" Height="600" Width="1000">
	<Window.Resources>
		<Style x:Key="UserQueryStyle" TargetType="TextBlock">
			<Setter Property="Background" Value="#E1F5FE"/>
			<Setter Property="Padding" Value="10"/>
			<Setter Property="Margin" Value="10,5"/>
			<Setter Property="TextWrapping" Value="Wrap"/>
			<Setter Property="HorizontalAlignment" Value="Right"/>
		</Style>
		<Style x:Key="ModelResponseStyle" TargetType="TextBlock">
			<Setter Property="Background" Value="#F1F8E9"/>
			<Setter Property="Padding" Value="10"/>
			<Setter Property="Margin" Value="10,5"/>
			<Setter Property="TextWrapping" Value="Wrap"/>
			<Setter Property="HorizontalAlignment" Value="Left"/>
		</Style>

		<!-- Style for compact parameter controls -->
		<Style x:Key="CompactSliderStyle" TargetType="Slider">
			<Setter Property="Margin" Value="5,0"/>
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="Width" Value="80"/>
		</Style>

		<Style x:Key="CompactTextBoxStyle" TargetType="TextBox">
			<Setter Property="Width" Value="40"/>
			<Setter Property="Margin" Value="2,0"/>
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="TextAlignment" Value="Center"/>
			<Setter Property="FontSize" Value="11"/>
		</Style>

		<Style x:Key="CompactLabelStyle" TargetType="TextBlock">
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="FontSize" Value="11"/>
			<Setter Property="Margin" Value="0,0,3,0"/>
		</Style>

		<BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
		<local:InverseBooleanToVisibilityConverter x:Key="NotProcessedToVisibilityConverter"/>
		<local:StatusColorConverter x:Key="StatusColorConverter"/>
	</Window.Resources>

	<Grid>
		<DockPanel>
			<Menu DockPanel.Dock="Top" x:Name="MainMenu">
				<MenuItem Header="File">
					<MenuItem Header="Exit" Click="FileExit_Click"/>
				</MenuItem>
				<MenuItem Header="Tools">
					<MenuItem Header="RAG Diagnostics"
                              Command="{Binding DiagnosticsCommand}"
                              InputGestureText="Ctrl+Shift+D"/>
				</MenuItem>
			</Menu>

			<Grid>
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="Auto"/>
				</Grid.ColumnDefinitions>

				<Grid x:Name="ChatPanel" Grid.Column="0">
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<!-- New row for model parameters -->
						<RowDefinition Height="*"/>
						<RowDefinition Height="Auto"/>
					</Grid.RowDefinitions>

					<!-- Top toolbar with model selection and RAG toggle -->
					<Grid Grid.Row="0" Background="#F5F5F5">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<StackPanel Grid.Column="0" Orientation="Horizontal" Margin="10">
							<TextBlock Text="Model: " FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,5,0"/>
							<TextBlock x:Name="ModelNameTextBlock" Text="{Binding ModelName}"
                                       VerticalAlignment="Center"
                                       FontSize="16"/>
							<Button x:Name="MenuToggleButton" Content="Change Model" Margin="10,0,0,0"
                                    Padding="8,3" Click="MenuToggleButton_Click"/>
						</StackPanel>

						<StackPanel Grid.Column="1" Orientation="Horizontal" Margin="10,0">
							<CheckBox x:Name="RagEnableCheckBox" Content="Enable RAG"
                                      IsChecked="{Binding DocumentViewModel.IsRagEnabled, Mode=TwoWay}"
                                      VerticalAlignment="Center"
                                      Margin="0,0,10,0"
                                      Checked="RagEnableCheckBox_Checked"
                                      Unchecked="RagEnableCheckBox_Unchecked"/>
						</StackPanel>
					</Grid>

					<!-- NEW: Model Generation Parameters Panel -->
					<Expander Grid.Row="1" Header="Model Settings" Background="#FAFAFA" BorderBrush="#E0E0E0" BorderThickness="0,1,0,1">
						<Grid Margin="15,10">
							<Grid.RowDefinitions>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
							</Grid.RowDefinitions>

							<!-- Temperature Control -->
							<StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,2">
								<TextBlock Text="Temperature:" Style="{StaticResource CompactLabelStyle}" Width="70"/>
								<Slider Name="TemperatureSlider"
                                        Style="{StaticResource CompactSliderStyle}"
                                        Minimum="0.0" Maximum="2.0"
                                        Value="{Binding ConfigurationService.Temperature, Mode=TwoWay}"
                                        TickFrequency="0.1"
                                        IsSnapToTickEnabled="True"/>
								<TextBox Text="{Binding ConfigurationService.Temperature, StringFormat=F1, Mode=TwoWay}"
                                         Style="{StaticResource CompactTextBoxStyle}"/>
								<TextBlock Text="(0.0=deterministic, 2.0=creative)"
                                           Style="{StaticResource CompactLabelStyle}"
                                           FontStyle="Italic"
                                           Foreground="Gray"
                                           Margin="8,0,0,0"/>
							</StackPanel>

							<!-- Top-P Control -->
							<StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,2">
								<TextBlock Text="Top-P:" Style="{StaticResource CompactLabelStyle}" Width="70"/>
								<Slider Name="TopPSlider"
                                        Style="{StaticResource CompactSliderStyle}"
                                        Minimum="0.0" Maximum="1.0"
                                        Value="{Binding ConfigurationService.TopP, Mode=TwoWay}"
                                        TickFrequency="0.05"
                                        IsSnapToTickEnabled="True"/>
								<TextBox Text="{Binding ConfigurationService.TopP, StringFormat=F2, Mode=TwoWay}"
                                         Style="{StaticResource CompactTextBoxStyle}"/>
								<TextBlock Text="(0.1=focused, 1.0=diverse)"
                                           Style="{StaticResource CompactLabelStyle}"
                                           FontStyle="Italic"
                                           Foreground="Gray"
                                           Margin="8,0,0,0"/>
							</StackPanel>

							<!-- Quick Presets -->
							<StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,8,0,2">
								<TextBlock Text="Presets:" Style="{StaticResource CompactLabelStyle}" Width="70"/>
								<Button Content="Conservative"
                                        Click="SetConservativePreset_Click"
                                        Padding="8,2"
                                        Margin="2,0"
                                        FontSize="11"
                                        ToolTip="Temperature: 0.3, Top-P: 0.7"/>
								<Button Content="Balanced"
                                        Click="SetBalancedPreset_Click"
                                        Padding="8,2"
                                        Margin="2,0"
                                        FontSize="11"
                                        ToolTip="Temperature: 0.7, Top-P: 0.9"/>
								<Button Content="Creative"
                                        Click="SetCreativePreset_Click"
                                        Padding="8,2"
                                        Margin="2,0"
                                        FontSize="11"
                                        ToolTip="Temperature: 1.2, Top-P: 0.95"/>
							</StackPanel>
						</Grid>
					</Expander>

					<!-- Chat History -->
					<ScrollViewer x:Name="ChatHistoryScrollViewer"
                                  Grid.Row="2"
                                  VerticalScrollBarVisibility="Auto">
						<ItemsControl x:Name="ChatHistoryItemsControl" ItemsSource="{Binding ChatHistory}">
							<ItemsControl.ItemTemplate>
								<DataTemplate>
									<StackPanel>
										<TextBlock Text="{Binding UserQuery}"
                                                   Style="{StaticResource UserQueryStyle}"/>

										<StackPanel>
											<TextBlock Text="{Binding ModelResponse}"
                                                       Style="{StaticResource ModelResponseStyle}"/>

											<TextBlock Text="Sources used for this response"
                                                       Visibility="{Binding UsedRag, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                       Margin="10,0,10,5"
                                                       FontStyle="Italic"
                                                       FontSize="11"
                                                       Foreground="Gray"/>

											<ItemsControl ItemsSource="{Binding SourceChunkIds}"
                                                          Visibility="{Binding UsedRag, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                          Margin="20,0,10,10">
												<ItemsControl.ItemTemplate>
													<DataTemplate>
														<TextBlock Text="{Binding}"
                                                                   FontSize="10"
                                                                   Foreground="Gray"/>
													</DataTemplate>
												</ItemsControl.ItemTemplate>
											</ItemsControl>
										</StackPanel>
									</StackPanel>
								</DataTemplate>
							</ItemsControl.ItemTemplate>
						</ItemsControl>
					</ScrollViewer>

					<!-- Input Area -->
					<Grid Grid.Row="3" Background="#F5F5F5">
						<TextBox x:Name="UserInputTextBox"
                                 Text="{Binding UserInput, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="10"
                                 Padding="5"
                                 FontSize="14"
                                 PreviewKeyDown="UserInputTextBox_PreviewKeyDown"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Auto"
                                 MinHeight="50"
                                 MaxHeight="150"/>
					</Grid>

					<!-- Loading Indicator -->
					<Border x:Name="LoadingIndicator"
                            Grid.RowSpan="4"
                            Background="#80000000"
                            Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
						<StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
							<TextBlock Text="Generating response..."
                                       Foreground="White"
                                       FontSize="16"
                                       Margin="0,0,0,10"/>
							<ProgressBar IsIndeterminate="True"
                                         Width="200"
                                         Height="10"/>
						</StackPanel>
					</Border>
				</Grid>

				<!-- RAG Panel (unchanged) -->
				<Grid x:Name="RagPanel" Grid.Column="1" Width="300" Background="White"
                      Visibility="Collapsed" Panel.ZIndex="1">
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto" />
						<RowDefinition Height="*" />
					</Grid.RowDefinitions>

					<Button Grid.Row="0"
							Content="RAG Settings"
							Command="{Binding DocumentViewModel.OpenRagSettingsCommand}"
							Margin="10,5,10,5"
							Padding="5,2"
							HorizontalAlignment="Stretch"/>
					<views:DocumentLibraryView Grid.Row="1"
											  DataContext="{Binding DocumentViewModel}"
											  BorderBrush="#DDDDDD"
											  BorderThickness="1,0,0,0"/>
				</Grid>
			</Grid>
		</DockPanel>
	</Grid>
</Window>