<Window x:Class="ollamidesk.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:views="clr-namespace:ollamidesk.RAG.Views"
        xmlns:local="clr-namespace:ollamidesk"
        Title="Ollama Chat" Height="600" Width="1000">
	<Window.Resources>
		<Style x:Key="UserQueryStyle" TargetType="TextBlock">
			<Setter Property="Background" Value="#E1F5FE"/>
			<Setter Property="Padding" Value="10"/>
			<Setter Property="Margin" Value="10,5"/>
			<Setter Property="TextWrapping" Value="Wrap"/>
			<Setter Property="HorizontalAlignment" Value="Right"/>
		</Style>
		<Style x:Key="ModelResponseStyle" TargetType="TextBlock">
			<Setter Property="Background" Value="#F1F8E9"/>
			<Setter Property="Padding" Value="10"/>
			<Setter Property="Margin" Value="10,5"/>
			<Setter Property="TextWrapping" Value="Wrap"/>
			<Setter Property="HorizontalAlignment" Value="Left"/>
		</Style>

		<!-- Converters -->
		<BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

		<local:InverseBooleanToVisibilityConverter x:Key="NotProcessedToVisibilityConverter"/>
		<local:StatusColorConverter x:Key="StatusColorConverter"/>
	</Window.Resources>

	<Grid>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="300"/>
			<ColumnDefinition Width="*"/>
		</Grid.ColumnDefinitions>

		<!-- Document Library Panel -->
		<views:DocumentLibraryView Grid.Column="0"
                                   DataContext="{Binding DocumentViewModel}"
                                   BorderBrush="#DDDDDD"
                                   BorderThickness="0,0,1,0"/>

		<!-- Chat Panel -->
		<Grid Grid.Column="1">
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="*"/>
				<RowDefinition Height="Auto"/>
			</Grid.RowDefinitions>

			<!-- Top Bar -->
			<Grid Grid.Row="0" Background="#F5F5F5">
				<StackPanel Orientation="Horizontal" Margin="10">
					<TextBlock Text="Model: " FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,5,0"/>
					<TextBlock x:Name="ModelNameTextBlock" Text="{Binding ModelName}"
                               VerticalAlignment="Center"
                               FontSize="16"/>
					<Button x:Name="MenuToggleButton" Content="Change Model" Margin="10,0,0,0"
                            Padding="8,3" Click="MenuToggleButton_Click"/>
				</StackPanel>
			</Grid>

			<!-- Chat History -->
			<ScrollViewer x:Name="ChatHistoryScrollViewer"
                          Grid.Row="1"
                          VerticalScrollBarVisibility="Auto">
				<ItemsControl x:Name="ChatHistoryItemsControl" ItemsSource="{Binding ChatHistory}">
					<ItemsControl.ItemTemplate>
						<DataTemplate>
							<StackPanel>
								<!-- User Query -->
								<TextBlock Text="{Binding UserQuery}"
                                           Style="{StaticResource UserQueryStyle}"/>

								<!-- Model Response -->
								<StackPanel>
									<TextBlock Text="{Binding ModelResponse}"
                                               Style="{StaticResource ModelResponseStyle}"/>

									<!-- RAG Sources (if any) -->
									<TextBlock Text="Sources used for this response"
                                               Visibility="{Binding UsedRag, Converter={StaticResource BooleanToVisibilityConverter}}"
                                               Margin="10,0,10,5"
                                               FontStyle="Italic"
                                               FontSize="11"
                                               Foreground="Gray"/>

									<ItemsControl ItemsSource="{Binding SourceChunkIds}"
                                                  Visibility="{Binding UsedRag, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                  Margin="20,0,10,10">
										<ItemsControl.ItemTemplate>
											<DataTemplate>
												<TextBlock Text="{Binding}"
                                                           FontSize="10"
                                                           Foreground="Gray"/>
											</DataTemplate>
										</ItemsControl.ItemTemplate>
									</ItemsControl>
								</StackPanel>
							</StackPanel>
						</DataTemplate>
					</ItemsControl.ItemTemplate>
				</ItemsControl>
			</ScrollViewer>

			<!-- User Input Area -->
			<Grid Grid.Row="2" Background="#F5F5F5">
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="Auto"/>
				</Grid.ColumnDefinitions>
				<TextBox x:Name="UserInputTextBox"
                         Grid.Column="0"
                         Text="{Binding UserInput, UpdateSourceTrigger=PropertyChanged}"
                         Margin="10"
                         Padding="5"
                         FontSize="14"
                         KeyDown="UserInputTextBox_KeyDown"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         VerticalScrollBarVisibility="Auto"
                         MinHeight="50"
                         MaxHeight="150"/>
				<Button x:Name="SendButton"
                        Grid.Column="1"
                        Content="Send"
                        Command="{Binding SendMessageCommand}"
                        Click="SendButton_Click"
                        Margin="0,10,10,10"
                        Padding="10,5"/>
			</Grid>

			<!-- Loading Indicator -->
			<Border x:Name="LoadingIndicator"
                    Grid.RowSpan="3"
                    Background="#80000000"
                    Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
				<StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
					<TextBlock Text="Generating response..."
                               Foreground="White"
                               FontSize="16"
                               Margin="0,0,0,10"/>
					<ProgressBar IsIndeterminate="True"
                                 Width="200"
                                 Height="10"/>
				</StackPanel>
			</Border>
		</Grid>
	</Grid>
</Window>