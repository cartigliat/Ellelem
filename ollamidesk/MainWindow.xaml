<Window x:Class="ollamidesk.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:views="clr-namespace:ollamidesk.RAG.Views"
        xmlns:local="clr-namespace:ollamidesk"
        Title="Ollama Chat" Height="600" Width="1000"
        MinWidth="700" MinHeight="400"
        Opacity="0"> <!-- Start with Opacity 0 -->
	<Window.Resources>
		<!-- UserQueryStyle and ModelResponseStyle removed -->

		<!-- Style for compact parameter controls -->
		<Style x:Key="CompactSliderStyle" TargetType="Slider">
			<Setter Property="Margin" Value="5,0"/>
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="Width" Value="80"/>
		</Style>

		<Style x:Key="CompactTextBoxStyle" TargetType="TextBox">
			<Setter Property="Width" Value="40"/>
			<Setter Property="Margin" Value="2,0"/>
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="TextAlignment" Value="Center"/>
			<Setter Property="FontSize" Value="11"/>
		</Style>

		<Style x:Key="CompactLabelStyle" TargetType="TextBlock">
			<Setter Property="VerticalAlignment" Value="Center"/>
			<Setter Property="FontSize" Value="11"/>
			<Setter Property="Margin" Value="0,0,3,0"/>
		</Style>

		<BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
		<local:InverseBooleanToVisibilityConverter x:Key="NotProcessedToVisibilityConverter"/>
		<local:StatusColorConverter x:Key="StatusColorConverter"/>
	</Window.Resources>

    <Window.Triggers>
        <EventTrigger RoutedEvent="Window.Loaded">
            <BeginStoryboard>
                <Storyboard>
                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                     From="0.0" To="1.0" Duration="0:0:0.5" /> <!-- 0.5 second fade-in -->
                </Storyboard>
            </BeginStoryboard>
        </EventTrigger>
    </Window.Triggers>

	<Grid>
		<DockPanel>
			<!-- Menu removed -->
			<Grid>
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*"/>
					<ColumnDefinition Width="Auto"/>
				</Grid.ColumnDefinitions>

				<Grid x:Name="ChatPanel" Grid.Column="0">
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<!-- New row for model parameters -->
						<RowDefinition Height="*"/>
						<RowDefinition Height="Auto"/>
					</Grid.RowDefinitions>

					<!-- Top toolbar with model selection and RAG toggle -->
                    <Grid Grid.Row="0"> <!-- Background removed to be inherited from global styles -->
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/> <!-- For Settings Button -->
                            <ColumnDefinition Width="*"/>   <!-- For Model Name / other elements -->
                            <ColumnDefinition Width="Auto"/> <!-- For RAG Toggle -->
                        </Grid.ColumnDefinitions>

                        <!-- Settings Button (New) -->
                        <Button x:Name="SettingsButton" Grid.Column="0" Content="⚙️"
                                VerticalAlignment="Center" Margin="10" Padding="8,5"
                                ToolTip="Settings">
                            <Button.ContextMenu>
                                <ContextMenu Style="{StaticResource {x:Type ContextMenu}}">
                                    <MenuItem Header="Change Model" Click="MenuToggleButton_Click" Style="{StaticResource {x:Type MenuItem}}"/>
                                    <MenuItem Header="RAG Diagnostics" Command="{Binding DiagnosticsCommand}" InputGestureText="Ctrl+Shift+D" Style="{StaticResource {x:Type MenuItem}}"/>
                                    <Separator Style="{StaticResource {x:Type Separator}}"/>
                                    <MenuItem Header="Exit" Click="FileExit_Click" Style="{StaticResource {x:Type MenuItem}}"/>
                                </ContextMenu>
                            </Button.ContextMenu>
                        </Button>

                        <!-- Model Name Display (Adjusted) -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Left" Margin="10,0,0,0">
                            <TextBlock Text="Model: " FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,5,0" Style="{StaticResource {x:Type TextBlock}}"/>
                            <TextBlock x:Name="ModelNameTextBlock" Text="{Binding ModelName}"
                                       VerticalAlignment="Center" FontSize="{StaticResource LargeFontSize}"/>
                        </StackPanel>

                        <!-- RAG Toggle (Existing, ensure it's in the right column) -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="10,0">
                            <TextBlock Text="Enable RAG:" VerticalAlignment="Center" Margin="0,0,5,0" Style="{StaticResource {x:Type TextBlock}}"/>
                            <CheckBox x:Name="RagEnableCheckBox"
                                      IsChecked="{Binding DocumentViewModel.IsRagEnabled, Mode=TwoWay}"
                                      VerticalAlignment="Center"
                                      Margin="0,0,10,0"
                                      Checked="RagEnableCheckBox_Checked"
                                      Unchecked="RagEnableCheckBox_Unchecked"
                                      Style="{StaticResource ModernToggleSwitchStyle}"
                                      ToolTip="Toggle RAG Panel"/>
                        </StackPanel>
                    </Grid>

					<!-- NEW: Model Generation Parameters Panel -->
					<Expander Grid.Row="1" Header="Model Settings" Background="#FAFAFA" BorderBrush="#E0E0E0" BorderThickness="0,1,0,1">
						<Grid Margin="15,10">
							<Grid.RowDefinitions>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
							</Grid.RowDefinitions>

							<!-- Temperature Control -->
							<StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,2">
								<TextBlock Text="Temperature:" Style="{StaticResource CompactLabelStyle}" Width="70"/>
								<Slider Name="TemperatureSlider"
                                        Style="{StaticResource CompactSliderStyle}"
                                        Minimum="0.0" Maximum="2.0"
                                        Value="{Binding ConfigurationService.Temperature, Mode=TwoWay}"
                                        TickFrequency="0.1"
                                        IsSnapToTickEnabled="True"/>
								<TextBox Text="{Binding ConfigurationService.Temperature, StringFormat=F1, Mode=TwoWay}"
                                         Style="{StaticResource CompactTextBoxStyle}"/>
								<TextBlock Text="(0.0=deterministic, 2.0=creative)"
                                           Style="{StaticResource CompactLabelStyle}"
                                           FontStyle="Italic"
                                           Foreground="Gray"
                                           Margin="8,0,0,0"/>
							</StackPanel>

							<!-- Top-P Control -->
							<StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,2">
								<TextBlock Text="Top-P:" Style="{StaticResource CompactLabelStyle}" Width="70"/>
								<Slider Name="TopPSlider"
                                        Style="{StaticResource CompactSliderStyle}"
                                        Minimum="0.0" Maximum="1.0"
                                        Value="{Binding ConfigurationService.TopP, Mode=TwoWay}"
                                        TickFrequency="0.05"
                                        IsSnapToTickEnabled="True"/>
								<TextBox Text="{Binding ConfigurationService.TopP, StringFormat=F2, Mode=TwoWay}"
                                         Style="{StaticResource CompactTextBoxStyle}"/>
								<TextBlock Text="(0.1=focused, 1.0=diverse)"
                                           Style="{StaticResource CompactLabelStyle}"
                                           FontStyle="Italic"
                                           Foreground="Gray"
                                           Margin="8,0,0,0"/>
							</StackPanel>

							<!-- Quick Presets -->
							<StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,8,0,2">
								<TextBlock Text="Presets:" Style="{StaticResource CompactLabelStyle}" Width="70"/>
								<Button Content="Conservative"
                                        Click="SetConservativePreset_Click"
                                        Padding="8,2"
                                        Margin="2,0"
                                        FontSize="11"
                                        ToolTip="Temperature: 0.3, Top-P: 0.7"/>
								<Button Content="Balanced"
                                        Click="SetBalancedPreset_Click"
                                        Padding="8,2"
                                        Margin="2,0"
                                        FontSize="11"
                                        ToolTip="Temperature: 0.7, Top-P: 0.9"/>
								<Button Content="Creative"
                                        Click="SetCreativePreset_Click"
                                        Padding="8,2"
                                        Margin="2,0"
                                        FontSize="11"
                                        ToolTip="Temperature: 1.2, Top-P: 0.95"/>
							</StackPanel>
						</Grid>
					</Expander>

					<!-- Chat History -->
					<ScrollViewer x:Name="ChatHistoryScrollViewer"
                                  Grid.Row="2"
                                  VerticalScrollBarVisibility="Auto">
                        <ItemsControl x:Name="ChatHistoryItemsControl" ItemsSource="{Binding ChatHistory}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="0,0,0,10">
                                        <!-- User Query -->
                                        <Border Background="{StaticResource SecondaryBackgroundBrush}"
                                                HorizontalAlignment="Right"
                                                Padding="10" Margin="50,5,10,5" CornerRadius="10" MaxWidth="500"
                                                Visibility="{Binding UserQuery, Converter={StaticResource StringToVisibilityWithCollapseConverter}}">
                                            <TextBlock Text="{Binding UserQuery}" TextWrapping="Wrap" Foreground="{StaticResource PrimaryForegroundBrush}"/>
                                        </Border>

                                        <!-- Model Response & Sources -->
                                        <StackPanel HorizontalAlignment="Left"
                                                    Visibility="{Binding ModelResponse, Converter={StaticResource StringToVisibilityWithCollapseConverter}}">
                                            <Border Background="{StaticResource TertiaryBackgroundBrush}"
                                                    Padding="10" Margin="10,5,50,5" CornerRadius="10" MaxWidth="500">
                                                <TextBlock Text="{Binding ModelResponse}" TextWrapping="Wrap" Foreground="{StaticResource PrimaryForegroundBrush}"/>
                                            </Border>
                                            <StackPanel Visibility="{Binding UsedRag, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="15,0,10,5">
                                                <TextBlock Text="📄 Sources:" FontSize="{StaticResource SmallFontSize}" Foreground="{StaticResource SecondaryForegroundBrush}" Margin="0,5,0,2"/>
                                                <ItemsControl ItemsSource="{Binding SourceChunkIds}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate>
                                                            <WrapPanel Orientation="Horizontal"/>
                                                        </ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Border Background="{StaticResource SecondaryBackgroundBrush}" CornerRadius="5" Padding="5,2" Margin="0,0,5,2">
                                                                <TextBlock Text="{Binding}" FontSize="{StaticResource SmallFontSize}" Foreground="{StaticResource PrimaryForegroundBrush}"/>
                                                            </Border>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

					<!-- Input Area -->
                    <Grid Grid.Row="3"> <!-- Removed Background="#F5F5F5" -->
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/> <!-- TextBox takes available space -->
                            <ColumnDefinition Width="Auto"/> <!-- Button takes its own space -->
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="UserInputTextBox"
                                 Grid.Column="0"
                                 Text="{Binding UserInput, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="10,10,5,10" <!-- Adjusted right margin -->
                                 Padding="5"
                                 FontSize="14"
                                 PreviewKeyDown="UserInputTextBox_PreviewKeyDown"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Auto"
                                 MinHeight="50"
                                 MaxHeight="150"
                                 Style="{StaticResource {x:Type TextBox}}"/> <!-- Ensure global style is applied -->

                        <Button x:Name="SendButton"
                                Grid.Column="1"
                                Content="➢"
                                ToolTip="Send Message"
                                Click="SendButton_Click"
                                Style="{StaticResource {x:Type Button}}"
                                VerticalAlignment="Bottom"
                                Margin="0,0,10,10" <!-- Align with TextBox bottom margin -->
                                Padding="12,8"/> <!-- Slightly larger padding for a send button -->
                    </Grid>

					<!-- Loading Indicator -->
                    <Border x:Name="LoadingIndicator"
                            Grid.RowSpan="4"
                            Background="#A01E1E1E" <!-- Semi-transparent PrimaryBackgroundBrush -->
                            Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <TextBlock Text="Generating response..."
                                       Foreground="{StaticResource PrimaryForegroundBrush}" <!-- Themed Foreground -->
                                       FontSize="16"
                                       Margin="0,0,0,10"/>
                            <ProgressBar IsIndeterminate="True"
                                         Width="200"
                                         Height="10" Style="{StaticResource {x:Type ProgressBar}}"/> <!-- Ensure ProgressBar is styled -->
                        </StackPanel>
                    </Border>
				</Grid>

				<!-- RAG Panel (unchanged) -->
				<Grid x:Name="RagPanel" Grid.Column="1" Width="300" Background="White"
                      Visibility="Collapsed" Panel.ZIndex="1">
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto" />
						<RowDefinition Height="*" />
					</Grid.RowDefinitions>

					<Button Grid.Row="0"
							Content="RAG Settings"
							Command="{Binding DocumentViewModel.OpenRagSettingsCommand}"
							Margin="10,5,10,5"
							Padding="5,2"
							HorizontalAlignment="Stretch"/>
					<views:DocumentLibraryView Grid.Row="1"
											  DataContext="{Binding DocumentViewModel}"
											  BorderBrush="#DDDDDD"
											  BorderThickness="1,0,0,0"/>
				</Grid>
			</Grid>
		</DockPanel>
	</Grid>
</Window>